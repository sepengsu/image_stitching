# 원통형 투영 알고리즘 (Cylindrical Projection Algorithm)

## 1. 소개

원통형 투영은 여러 장의 이미지를 자연스럽게 이어 붙이는 이미지 스티칭에서 중요한 단계입니다. 특히 넓은 시야각의 파노라마를 생성할 때 매우 유용합니다. 이 문서는 주어진 3장의 입력 이미지에 대해 카메라 보정이나 메타데이터 없이 원통형 투영을 적용하는 알고리즘을 설명합니다.

---

## 2. 알고리즘의 주요 단계

### **Step 1: 이미지 로딩 및 전처리**

* 3장의 입력 이미지를 불러옵니다.
* 계산 속도를 높이기 위해 각 이미지를 그레이스케일로 변환합니다.

### **Step 2: 키포인트 검출**

* 각 이미지에서 SIFT, SURF 또는 ORB 알고리즘을 사용하여 키포인트와 디스크립터를 추출합니다.
* 이미지 전역에 걸쳐 고르게 분포된 특징점을 검출하여 강력한 매칭을 보장합니다.

### **Step 3: 키포인트 매칭**

* 각 이미지 쌍 (예: 1-2, 2-3, 1-3) 사이에서 키포인트를 매칭합니다.
* KNN 또는 FLANN 알고리즘을 사용하여 매칭을 수행합니다.
* Lowe’s ratio test 또는 RANSAC을 적용하여 잘못된 매칭을 필터링합니다.

### **Step 4: 호모그래피 계산**

* 매칭된 키포인트를 사용하여 각 이미지 쌍의 3x3 호모그래피 행렬을 계산합니다.
* RANSAC을 사용하여 아웃라이어를 제거하고 정확한 변환을 보장합니다.

### **Step 5: 초점 거리 (f) 추정**

* 원통형 투영을 위해서는 적절한 초점 거리 (f)의 설정이 필수적입니다.
* 다음의 방법을 활용하여 f를 추정할 수 있습니다:

  1. **수평 시야각 (HFOV) 접근법:**

     * 다음 공식 사용:
       $f = \frac{W}{2 \tan\left(\frac{\theta}{2}\right)}$
     * 여기서 W는 이미지의 가로 길이, θ는 일반적으로 60°에서 75° 사이의 시야각.
  2. **키포인트 분포 분석:**

     * 키포인트의 분포를 기반으로 여러 매칭 점들에 대해 f를 최적화.
  3. **실험적 튜닝:**

     * 500에서 1000 픽셀 사이의 f 값을 테스트하여 가장 자연스러운 결과를 선택.

### **Step 6: 원통형 매핑**

* 추정된 f를 사용하여 각 이미지를 원통형 표면에 투영합니다:
  $\theta = \arctan\left(\frac{x - c_x}{f}\right)$
  $h = \frac{y - c_y}{\sqrt{(x - c_x)^2 + f^2}}$
  $x' = f \cdot \theta + c_x'$
  $y' = f \cdot h + c_y'$

### **Step 7: 이미지 왜곡 및 정렬**

* 계산된 호모그래피를 사용하여 각 이미지를 원통형 표면에 맞춰 변형합니다.
* 이미지의 겹치는 영역을 기준으로 정렬합니다.

### **Step 8: 블렌딩 및 최종 합성**

* Multi-band 블렌딩, Poisson 블렌딩 또는 단순 선형 블렌딩을 적용하여 경계선을 최소화합니다.
* 각 이미지의 색상을 일관되게 유지하여 자연스러운 결과를 만듭니다.

### **Step 9: 후처리 및 내보내기**

* 블랙 보더나 잘린 부분을 제거하여 최종 이미지를 크롭합니다.
* 최종 스티칭된 이미지를 파일로 저장합니다.

---

## 3. 참고 사항

* f 추정이 정확하지 않으면 왜곡이 심해질 수 있습니다.
* 블렌딩 단계를 여러 번 반복하여 더 부드러운 전환을 구현할 수 있습니다.
* 호모그래피가 정확해야 고스트 현상이나 오정렬을 피할 수 있습니다.

---

## 4. 향후 개선 방안

* 심도 기반의 적응형 f 추정 기법 도입 가능.
* 실시간 스티칭을 위한 최적화 알고리즘 고려.
* 자동 노출 및 색상 보정을 추가하여 보다 자연스러운 출력.
