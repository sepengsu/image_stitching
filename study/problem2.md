# 전체 이미지 스티칭 알고리즘 (Fundamental Matrix 기반 초점 거리 추정 포함)

---

## 1. 개요

이미지 스티칭은 여러 장의 이미지를 자연스럽게 연결하여 하나의 파노라마 이미지를 생성하는 기술입니다. 이 알고리즘은 각 이미지의 겹치는 영역을 찾아 변형하고 정합하여 최종적으로 하나의 일관된 이미지를 만드는 과정입니다. 본 문서에서는 \*\*Fundamental Matrix (E Matrix 변환)\*\*을 이용하여 \*\*초점 거리 (f)\*\*를 전처리에서 추정하는 방법을 포함하여 2장, 3장, 8장의 이미지를 스티칭하는 전체 과정을 설명합니다.

---

## 2. 알고리즘 주요 단계

### **Step 1: 이미지 로딩 및 전처리 (Image Loading and Preprocessing)**

* 입력 이미지를 불러옵니다 (예: 2장, 3장, 8장).
* 각 이미지를 그레이스케일로 변환하여 처리 속도를 향상시킵니다.
* 이미지의 크기와 해상도를 통일하여 왜곡을 최소화합니다.

---

### **Step 2: 초점 거리 (f) 추정 (Focal Length Estimation)**

* \*\*Fundamental Matrix (E Matrix 변환)\*\*을 활용하여 **f**를 전처리 단계에서 추정합니다.
* **RANSAC**을 사용하여 아웃라이어를 제거하고, 매칭의 안정성을 강화합니다.
* 초점 거리 추정 절차:

  1. **키포인트 검출:**

     * 각 이미지에서 SIFT, SURF 또는 ORB 알고리즘을 사용하여 강력한 키포인트와 디스크립터를 추출합니다.
     * 초기 매칭 품질이 매우 중요하므로, 넓은 범위의 특징점을 고르게 검출해야 합니다.

  2. **키포인트 매칭:**

     * 각 이미지 쌍 (예: 1-2, 2-3, 1-3) 사이에서 키포인트를 매칭합니다.
     * KNN 매칭 또는 FLANN 매칭 알고리즘을 사용하여 효율적으로 매칭을 수행합니다.
     * RANSAC을 통해 아웃라이어를 제거하여 정확도를 높입니다.

  3. **Fundamental Matrix 계산:**

     * 매칭된 키포인트를 바탕으로 **Fundamental Matrix**를 계산합니다.
     * 이 행렬에서 **Essential Matrix**를 추출하여 **f**를 결정합니다.
     * 수학적으로 더 정확하고, 다양한 촬영 환경에서 강건한 모델을 제공합니다.

  4. **f 추정 결과의 보정:**

     * 초기 매칭 품질이 낮을 경우 **SIFT, ORB**와 같은 강력한 특징점 검출기를 사용하여 개선합니다.
     * 넓은 시야각의 경우 **Radial Distortion 보정**을 고려해야 합니다.

---

### **Step 3: 원통형 투영 (Cylindrical Projection)**

* 추정된 **f**를 사용하여 각 이미지를 원통형 표면으로 투영합니다.
* 투영 공식:

$$
\theta = \arctan\left(\frac{x - c_x}{f}\right)
$$

$$
h = \frac{y - c_y}{\sqrt{(x - c_x)^2 + f^2}}
$$

$$
x' = f \cdot \theta + c_x'
$$

$$
y' = f \cdot h + c_y'
$$

* 이 단계에서 왜곡을 최소화하기 위해 이미지의 중심을 기준으로 투영을 수행합니다.

---

### **Step 4: 키포인트 재검출 (Re-Detection of Keypoints)**

* 원통형으로 투영된 이미지에서 다시 키포인트를 검출합니다.
* 투영 변환으로 인해 특징점의 위치가 변할 수 있기 때문에, 재검출을 통해 정밀도를 높입니다.

---

### **Step 5: 호모그래피 행렬 계산 (Homography Estimation)**

* 매칭된 키포인트를 바탕으로 각 이미지 쌍의 3x3 호모그래피 행렬을 계산합니다.
* **RANSAC**을 사용하여 아웃라이어를 제거하고 정확한 변환을 보장합니다.
* 호모그래피는 이미지의 전체적인 변형을 결정하는 중요한 요소입니다.

---

### **Step 6: 이미지 정렬 및 병합 (Image Warping and Alignment)**

* 계산된 호모그래피 행렬을 사용하여 각 이미지를 원통형으로 변형합니다.
* 변형된 이미지를 기준으로 최적의 정합 위치를 찾아 병합합니다.

---

### **Step 7: 블렌딩 및 최종 합성 (Blending and Final Composition)**

* 이미지의 경계선을 자연스럽게 연결하기 위해 블렌딩 기법을 적용합니다 (예: multi-band blending, Poisson blending).
* 색상 일관성을 유지하여 더 자연스러운 결과를 만듭니다.

---

### **Step 8: 후처리 및 최종 결과물 저장 (Post-Processing and Export)**

* 블랙 보더나 잘린 영역을 제거하여 최종 이미지를 크롭합니다.
* 최종 스티칭된 이미지를 파일로 저장합니다.

---
