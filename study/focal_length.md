# Focal Length 추정 방법

이미지 스티칭에서 원통형 투영을 위해 focal length (f)를 정확히 추정하는 다양한 방법을 다음과 같이 정리할 수 있습니다.

## 1. 이미지 매칭을 통한 Focal Length 추정 방법

| **방법론**                              | **설명**                               | **장점**                                                | **단점**                                    | **적용 사례**        |
| ------------------------------------ | ------------------------------------ | ----------------------------------------------------- | ----------------------------------------- | ---------------- |
| **Fundamental Matrix (E Matrix 변환)** | 키포인트 매칭 후, Essential Matrix로부터 f를 역산 | - 일반적인 기법<br>- RANSAC으로 outlier 제거 가능<br>- 수학적 정확성 높음 | - 노이즈와 outlier에 민감<br>- 이미지의 기본 기하 구조가 필요 | 3D 재구성, 로봇 내비게이션 |
| **Optical Flow와 Parallax**           | 이미지의 움직임 벡터를 통한 상대적 카메라 거리 추정        | - 빠른 계산 가능<br>- 영상에서 실시간 적용 가능                        | - 빠른 움직임에 민감<br>- 복잡한 환경에서 정확도 낮음         | 드론 비전, SLAM      |
| **Vanishing Point 기반 (DLT)**         | 소실점을 통해 카메라 내부 파라미터 추정               | - 건축물, 실내 환경에서 효과적<br>- 정확한 직선 구조에서 높은 정확도            | - 복잡한 장면에서 소실점 검출 어려움<br>- 이미지 왜곡에 민감     | AR/VR, 건축 시각화    |

## 2. Least Squares Optimization (Bundle Adjustment)

| **방법론**               | **설명**                       | **장점**                         | **단점**                    | **적용 사례**                           |
| --------------------- | ---------------------------- | ------------------------------ | ------------------------- | ----------------------------------- |
| **Bundle Adjustment** | 카메라 포즈와 focal length를 동시 최적화 | - 높은 정확도<br>- 비선형 최적화 기법 적용 가능 | - 계산 비용 큼<br>- 초기 추정치에 민감 | Structure from Motion (SfM), 3D 모델링 |

## 3. Multi-Image 방법 (Trifocal Tensor)

| **방법론** | **설명** | **장점** | **단점** | **적용 사례** |
| ------- | ------ | ------ | ------ | --------- |

## 4. Radial Distortion 보정과 Focal Length 추정

| **방법론**                  | **설명**                           | **장점**           | **단점**                                    | **적용 사례**       |
| ------------------------ | -------------------------------- | ---------------- | ----------------------------------------- | --------------- |
| **Radial Distortion 보정** | 이미지 왜곡을 보정하여 정확한 focal length 추정 | - 왜곡 보정으로 정확도 증가 | - 보정 과정에서 추가 계산 필요<br>- 왜곡 모델의 정확성에 따라 다름 | 렌즈 왜곡 보정, 사진 복원 |

## 5. RANSAC과 Focal Length

| **방법론**           | **설명**                         | **장점**                          | **단점**                       | **적용 사례**   |
| ----------------- | ------------------------------ | ------------------------------- | ---------------------------- | ----------- |
| **RANSAC 기반 최적화** | 반복적인 랜덤 샘플링으로 outlier 제거 후 최적화 | - outlier에 강함<br>- 일반적으로 높은 신뢰성 | - 계산 비용 높음<br>- 초기 매칭 품질에 민감 | SLAM, 패턴 인식 |

## 6. 실험적인 방법 (Deep Learning)

| **방법론**                           | **설명**                                    | **장점**                             | **단점**                       | **적용 사례**                         |
| --------------------------------- | ----------------------------------------- | ---------------------------------- | ---------------------------- | --------------------------------- |
| **Deep Learning (NeRF, SfM Net)** | CNN, Transformer 기반으로 focal length를 직접 추정 | - 큰 데이터셋에서 높은 성능<br>- 비선형 관계 학습 가능 | - 데이터셋 의존성 큼<br>- 학습 비용 매우 큼 | AR, 자율주행, 3D Scene Reconstruction |

## 7. 실험적 아이디어 (Self-Calibration)

| **방법론**              | **설명**           | **장점**                      | **단점**                  | **적용 사례**                     |
| -------------------- | ---------------- | --------------------------- | ----------------------- | ----------------------------- |
| **Self-Calibration** | 반복적인 내부 파라미터 최적화 | - 외부 파라미터 필요 없음<br>- 자동화 가능 | - 수렴 속도 느림<br>- 노이즈에 민감 | Robotics, Autonomous Vehicles |

---

# 어디서 해야하는 것인가

## 8. 어디서 Focal Length 측정/추정이 이루어져야 하는가

| **단계**       | **추정 시점**      | **장점**                             | **단점**                                         | **적용 방식**                     |
| ------------ | -------------- | ---------------------------------- | ---------------------------------------------- | ----------------------------- |
| **전처리 단계**   | 이미지 스티칭 전      | - 초기 정확도 향상<br>- 프로세스 안정성 증가       | - 카메라 EXIF 데이터 없을 시 추정 필요<br>- 초기 추정 오류 전파 가능성 | 영상 기반 focal length 추정 알고리즘 적용 |
| **스티칭 과정 중** | 이미지 정렬 단계      | - 실시간 조정 가능<br>- 매칭 품질 향상          | - 복잡도 증가<br>- 계산 시간 증가                         | Bundle Adjustment, 반복적 최적화    |
| **후처리 단계**   | 스티칭 완료 후 미세 조정 | - 최종 결과 품질 향상<br>- 다른 매개변수와 동시 최적화 | - 초기 오류 교정 한계<br>- 추가 처리 필요                    | 반복적 최적화, 시각적 검증               |

## 결론

원통형 투영에서 Focal Length의 추정은 주로 **전처리 단계**에서 이루어져야 합니다. 이는 초기의 정확한 Focal Length 추정이 이후의 이미지 정렬, 키포인트 매칭, 호모그래피 계산의 정확성에 큰 영향을 미치기 때문입니다. 전처리에서의 추정이 효과적인 이유는 다음과 같습니다:

1. **정확성 향상**: 초기 오류가 전체 파이프라인으로 전파되는 것을 방지하여 최종 결과의 품질을 높일 수 있습니다.

2. **계산 비용 절감**: 초기에 정확한 추정치를 확보하면 반복적인 최적화 단계를 줄일 수 있어 계산 비용을 크게 줄일 수 있습니다.

3. **프로세스 안정성**: 초기 파라미터가 안정적일수록 후속 이미지 정합 및 블렌딩이 안정적으로 수행될 수 있습니다.

4. **복잡성 감소**: 전처리에서 정확한 Focal Length를 사용하면 복잡한 후처리 단계를 단순화할 수 있습니다.

따라서, 최적의 이미지 스티칭 파이프라인을 위해서는 전처리 단계에서의 Focal Length 추정이 가장 중요한 요소로 작용합니다.

# 전처리에서의 Focal Length 선택

Fundamental Matrix (E Matrix 변환)을 전처리에서 사용하는 것이 좋은 이유:

1. **일반성 (Generality)**

   * 대부분의 일반적인 이미지 스티칭 시나리오에서 적용 가능.
   * 다양한 촬영 환경에서의 강건성 (robustness) 보장.

2. **Outlier 제거 가능 (RANSAC 활용)**

   * RANSAC 알고리즘을 결합하여 잘못된 매칭을 걸러내므로 노이즈에 강함.
   * 키포인트 매칭의 정확도가 높아짐.

3. **수학적 정밀도**

   * Essential Matrix는 카메라의 내부 파라미터를 포함하므로, 기하학적 정확도가 뛰어남.
   * 카메라의 3D 기하학적 특성을 직접적으로 반영.

4. **확장성**

   * 추후 추가적인 Bundle Adjustment나 BA 최적화에도 유리.
   * 더 복잡한 3D 구조 복원에 적합.

---

## ⚠️ 단점 보완 방안

* **초기 매칭 품질의 중요성**

  * 초기 키포인트 매칭 품질이 낮을 경우, 잘못된 Essential Matrix를 계산할 수 있음.
  * 이를 보완하기 위해 SIFT, ORB와 같은 강력한 특징점 검출기를 사용.

* **카메라 움직임의 제한**

  * Fundamental Matrix는 비교적 좁은 시야각에서 더 정확.
  * 넓은 시야각에서는 Radial Distortion 보정이 필요할 수 있음.
